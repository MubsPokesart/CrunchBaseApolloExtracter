{% extends "base.html" %}

{% block title %}Crunchbase Data Extractor - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-cog me-2"></i> Settings</h4>
            </div>
            <div class="card-body">
                <form id="settings-form">
                    <div class="mb-3">
                        <label for="industry_vertical" class="form-label">Industry Vertical</label>
                        <input type="text" class="form-control" id="industry_vertical" name="industry_vertical" 
                               value="{{ settings.industry_vertical }}">
                    </div>
                    <div class="mb-3">
                        <label for="industry" class="form-label">Industry</label>
                        <input type="text" class="form-control" id="industry" name="industry" 
                               value="{{ settings.industry }}">
                    </div>
                    <div class="mb-3">
                        <label for="sourcing_analyst" class="form-label">Sourcing Analyst</label>
                        <input type="text" class="form-control" id="sourcing_analyst" name="sourcing_analyst" 
                               value="{{ settings.sourcing_analyst }}">
                    </div>
                    <div class="mb-3">
                        <label for="investment_cycle" class="form-label">Investment Cycle</label>
                        <input type="text" class="form-control" id="investment_cycle" name="investment_cycle" 
                               value="{{ settings.investment_cycle }}">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Settings
                    </button>
                </form>
                
                <div class="mt-4">
                    <h5>Current Fixed Settings</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Prospect Quality Level
                            <span class="badge bg-primary rounded-pill">{{ settings.prospect_quality_level }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Sub-Pipeline
                            <span class="badge bg-primary rounded-pill">{{ settings.sub_pipeline }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Stage
                            <span class="badge bg-primary rounded-pill">{{ settings.stage }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-upload me-2"></i> Upload HTML Files</h4>
            </div>
            <div class="card-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">Select Crunchbase HTML File</label>
                        <input class="form-control" type="file" id="file" name="file" accept=".html,.htm">
                        <div class="form-text">Upload a Crunchbase company profile HTML file.</div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-cogs me-2"></i>Process File
                    </button>
                </form>
                
                <div class="mt-4">
                    <h5>Instructions</h5>
                    <ol class="list-group list-group-numbered">
                        <li class="list-group-item">Save a Crunchbase company profile as HTML (right-click and "Save Page As...")</li>
                        <li class="list-group-item">Update settings above if needed</li>
                        <li class="list-group-item">Upload the HTML file</li>
                        <li class="list-group-item">Click "Process File" to extract the data</li>
                        <li class="list-group-item">Download the resulting CSV files and email templates</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current Results Summary -->
{% if processed_results.contacts|length > 0 %}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0">
            <i class="fas fa-database me-2"></i> Current Processed Results
        </h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h5 class="card-title">Contacts</h5>
                        <p class="card-text display-4">{{ processed_results.contacts|length }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h5 class="card-title">Companies</h5>
                        <p class="card-text display-4">{{ processed_results.companies|length }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h5 class="card-title">Pipelines</h5>
                        <p class="card-text display-4">{{ processed_results.pipelines|length }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h5 class="card-title">Email Templates</h5>
                        <p class="card-text display-4">{{ processed_results.email_templates|length }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mb-4">
            <a href="{{ url_for('main.download_results') }}" id="download-all-btn" class="btn btn-primary me-2">
                <i class="fas fa-download me-2"></i>Download All Results
            </a>
            <button id="remove-last-btn" class="btn btn-warning me-2">
                <i class="fas fa-undo me-2"></i>Undo Last Result
            </button>
            <button id="reset-results-btn" class="btn btn-danger">
                <i class="fas fa-trash me-2"></i>Clear All Results
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Error Alert - initially hidden -->
<div id="error-alert" class="alert alert-danger d-none" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <span id="error-message"></span>
</div>

<!-- Loading Spinner - initially hidden -->
<div id="loading-spinner" class="text-center d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Processing file, please wait...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Utility Functions
    function showError(message) {
        const errorAlert = document.getElementById('error-alert');
        const errorMessage = document.getElementById('error-message');
        
        if (errorAlert && errorMessage) {
            errorMessage.textContent = message;
            errorAlert.classList.remove('d-none');
            
            // Scroll to error
            errorAlert.scrollIntoView({ behavior: 'smooth' });
        } else {
            // Fallback to standard alert if elements don't exist
            alert(message);
        }
    }

    function hideError() {
        const errorAlert = document.getElementById('error-alert');
        if (errorAlert) {
            errorAlert.classList.add('d-none');
        }
    }

    function toggleLoading(show) {
        const loadingSpinner = document.getElementById('loading-spinner');
        
        if (loadingSpinner) {
            if (show) {
                loadingSpinner.classList.remove('d-none');
            } else {
                loadingSpinner.classList.add('d-none');
            }
        }
    }

    function showToast(message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '1050';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        // Create toast content
        const toastContent = document.createElement('div');
        toastContent.className = 'd-flex';
        
        const toastBody = document.createElement('div');
        toastBody.className = 'toast-body';
        toastBody.textContent = message;
        
        const closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.className = 'btn-close btn-close-white me-2 m-auto';
        closeButton.setAttribute('data-bs-dismiss', 'toast');
        closeButton.setAttribute('aria-label', 'Close');
        
        toastContent.appendChild(toastBody);
        toastContent.appendChild(closeButton);
        toast.appendChild(toastContent);
        
        // Add toast to container
        toastContainer.appendChild(toast);
        
        // Initialize toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        
        // Show toast
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }

    // Data Rendering Utility Functions
    function renderTableFromData(data) {
        if (!data || data.length === 0) {
            return '<div class="alert alert-info">No data to display</div>';
        }

        // Get column headers
        const headers = Object.keys(data[0]);

        // Create table
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            ${headers.map(header => `<th>${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                ${headers.map(header => `
                                    <td>${row[header] || ''}</td>
                                `).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        return tableHtml;
    }

    function renderEmailTemplates(templates) {
        if (!templates || templates.length === 0) {
            return '<div class="alert alert-info">No email templates to display</div>';
        }

        return templates.map((template, index) => `
            <div class="card mb-3">
                <div class="card-header">Email Template #${index + 1}</div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded">${template}</pre>
                </div>
            </div>
        `).join('');
    }

    // Settings Update Function
    function updateSettings() {
        // Show loading spinner
        toggleLoading(true);
        
        // Hide any previous errors
        hideError();
        
        // Get form data
        const formData = {
            industry_vertical: document.getElementById('industry_vertical').value,
            industry: document.getElementById('industry').value,
            sourcing_analyst: document.getElementById('sourcing_analyst').value,
            investment_cycle: document.getElementById('investment_cycle').value
        };
        
        // Send API request
        fetch('/api/update-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                showToast('Settings updated successfully!', 'success');
            } else {
                // Show error message
                showError(data.message || 'Failed to update settings.');
            }
        })
        .catch(error => {
            showError('An error occurred: ' + error);
        })
        .finally(() => {
            // Hide loading spinner
            toggleLoading(false);
        });
    }

    // Process File Function
    function processFile() {
        // Show loading spinner
        toggleLoading(true);
        
        // Hide any previous errors
        hideError();
        
        // Get file
        const fileInput = document.getElementById('file');
        const file = fileInput.files[0];
        
        if (!file) {
            showError('Please select a file to upload.');
            toggleLoading(false);
            return;
        }
        
        // Get the button and store original content
        const submitButton = document.querySelector('#upload-form button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;
        
        // Update button to show loading state
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...`;
        submitButton.disabled = true;
        
        // Create form data
        const formData = new FormData();
        formData.append('file', file);
        
        // Send API request
        fetch('/api/process', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show preview modal
                showProcessedDataPreview(data);
            } else {
                // Show error message
                showError(data.message || 'Failed to process file.');
            }
        })
        .catch(error => {
            console.error('Error processing file:', error);
            showError('An error occurred: ' + error);
        })
        .finally(() => {
            // Restore button state
            submitButton.innerHTML = originalButtonHtml;
            submitButton.disabled = false;
            
            // Hide loading spinner
            toggleLoading(false);
        });
    }

    function showProcessedDataPreview(data) {
    // Create modal dynamically
    const modalHtml = `
    <div class="modal fade" id="processedDataPreviewModal" tabindex="-1" aria-labelledby="processedDataPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="processedDataPreviewModalLabel">New Data Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">Contacts</div>
                                <div class="card-body">
                                    <p class="card-text h3">${data.new_data.contacts.length}</p>
                                    <small class="text-muted">New entries</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">Companies</div>
                                <div class="card-body">
                                    <p class="card-text h3">${data.new_data.companies.length}</p>
                                    <small class="text-muted">New entries</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">Pipelines</div>
                                <div class="card-body">
                                    <p class="card-text h3">${data.new_data.pipelines.length}</p>
                                    <small class="text-muted">New entries</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">Email Templates</div>
                                <div class="card-body">
                                    <p class="card-text h3">${data.new_data.email_templates.length}</p>
                                    <small class="text-muted">New entries</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <ul class="nav nav-tabs" id="previewTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="preview-contacts-tab" data-bs-toggle="tab" data-bs-target="#preview-contacts" type="button" role="tab">Contacts</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="preview-companies-tab" data-bs-toggle="tab" data-bs-target="#preview-companies" type="button" role="tab">Companies</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="preview-pipelines-tab" data-bs-toggle="tab" data-bs-target="#preview-pipelines" type="button" role="tab">Pipelines</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="preview-emails-tab" data-bs-toggle="tab" data-bs-target="#preview-emails" type="button" role="tab">Email Templates</button>
                            </li>
                        </ul>

                        <div class="tab-content mt-3" id="previewTabsContent">
                            <div class="tab-pane fade show active" id="preview-contacts">
                                ${renderTableFromData(data.new_data.contacts)}
                            </div>
                            <div class="tab-pane fade" id="preview-companies">
                                ${renderTableFromData(data.new_data.companies)}
                            </div>
                            <div class="tab-pane fade" id="preview-pipelines">
                                ${renderTableFromData(data.new_data.pipelines)}
                            </div>
                            <div class="tab-pane fade" id="preview-emails">
                                ${renderEmailTemplates(data.new_data.email_templates)}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <span class="me-auto">
                        Total Existing Results: 
                        Contacts (${data.total_existing_results.contacts}), 
                        Companies (${data.total_existing_results.companies}), 
                        Pipelines (${data.total_existing_results.pipelines}), 
                        Email Templates (${data.total_existing_results.email_templates})
                    </span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-add-data">Confirm and Add</button>
                </div>
            </div>
        </div>
    </div>`;

    // Create modal container
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);

    // Get modal element
    const modalElement = document.getElementById('processedDataPreviewModal');

    // Initialize modal
    const previewModal = new bootstrap.Modal(modalElement);
    
    // Add event listener to remove modal from DOM when hidden
    modalElement.addEventListener('hidden.bs.modal', function () {
        // Remove the modal from the DOM
        modalContainer.remove();
    });

    // Show the modal
    previewModal.show();

    // Confirm button click handler
    document.getElementById('confirm-add-data').addEventListener('click', function() {
        // Send request to actually add the data
        fetch('/api/confirm-process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data.new_data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Close modal
                previewModal.hide();
                
                // Show success toast
                showToast('Data added successfully!', 'success');
                
                // Reload page to update results
                location.reload();
            } else {
                showError(result.message || 'Failed to add data');
            }
        })
        .catch(error => {
            showError('An error occurred: ' + error);
            });
        });
    }

    // DOMContentLoaded Event Listener
    document.addEventListener('DOMContentLoaded', function() {
        // Settings form submission
        const settingsForm = document.getElementById('settings-form');
        if (settingsForm) {
            settingsForm.addEventListener('submit', function(event) {
                event.preventDefault();
                updateSettings();
            });
        }
        
        // File upload form submission
        const uploadForm = document.getElementById('upload-form');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(event) {
                event.preventDefault();
                processFile();
            });
        }
        
        // Undo last result button
        const removeLastBtn = document.getElementById('remove-last-btn');
        if (removeLastBtn) {
            removeLastBtn.addEventListener('click', function() {
                // Show loading spinner
                toggleLoading(true);
                
                fetch('/api/remove-last-result', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        
                        // Show success toast
                        showToast('Last processed result removed successfully!', 'success');
                        
                        // Reload the page to update results
                        location.reload();
                    } else {
                        // Show error
                        showError(data.message || 'Failed to remove last result.');
                    }
                })
                .catch(error => {
                    showError('An error occurred: ' + error);
                })
                .finally(() => {
                    // Hide loading spinner
                    toggleLoading(false);
                });
            });
        }
        
        // Reset all results button
        const resetResultsBtn = document.getElementById('reset-results-btn');
        if (resetResultsBtn) {
            resetResultsBtn.addEventListener('click', function() {
                // Show confirmation dialog
                if (confirm('Are you sure you want to clear all processed results? This cannot be undone.')) {
                    // Show loading spinner
                    toggleLoading(true);
                    
                    fetch('/api/reset-results', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Show success toast
                            showToast('All processed results have been cleared!', 'success');
                            
                            // Reload the page to update results
                            location.reload();
                        } else {
                            // Show error
                            showError(data.message || 'Failed to clear results.');
                        }
                    })
                    .catch(error => {
                        showError('An error occurred: ' + error);
                    })
                    .finally(() => {
                        // Hide loading spinner
                        toggleLoading(false);
                    });
                }
            });
        }
    });
</script>
{% endblock %}