{% extends "base.html" %}

{% block title %}Crunchbase Data Extractor - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-cog me-2"></i> Settings</h4>
            </div>
            <div class="card-body">
                <form id="settings-form">
                    <div class="mb-3">
                        <label for="industry_vertical" class="form-label">Industry Vertical</label>
                        <input type="text" class="form-control" id="industry_vertical" name="industry_vertical" 
                               value="{{ settings.industry_vertical }}">
                    </div>
                    <div class="mb-3">
                        <label for="industry" class="form-label">Industry</label>
                        <input type="text" class="form-control" id="industry" name="industry" 
                               value="{{ settings.industry }}">
                    </div>
                    <div class="mb-3">
                        <label for="sourcing_analyst" class="form-label">Sourcing Analyst</label>
                        <input type="text" class="form-control" id="sourcing_analyst" name="sourcing_analyst" 
                               value="{{ settings.sourcing_analyst }}">
                    </div>
                    <div class="mb-3">
                        <label for="investment_cycle" class="form-label">Investment Cycle</label>
                        <input type="text" class="form-control" id="investment_cycle" name="investment_cycle" 
                               value="{{ settings.investment_cycle }}">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Settings
                    </button>
                </form>
                
                <div class="mt-4">
                    <h5>Current Fixed Settings</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Prospect Quality Level
                            <span class="badge bg-primary rounded-pill">{{ settings.prospect_quality_level }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Sub-Pipeline
                            <span class="badge bg-primary rounded-pill">{{ settings.sub_pipeline }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Stage
                            <span class="badge bg-primary rounded-pill">{{ settings.stage }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-upload me-2"></i> Upload HTML Files</h4>
            </div>
            <div class="card-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">Select Crunchbase HTML File</label>
                        <input class="form-control" type="file" id="file" name="file" accept=".html,.htm">
                        <div class="form-text">Upload a Crunchbase company profile HTML file.</div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-cogs me-2"></i>Process File
                    </button>
                </form>
                
                <div class="mt-4">
                    <h5>Instructions</h5>
                    <ol class="list-group list-group-numbered">
                        <li class="list-group-item">Save a Crunchbase company profile as HTML (right-click and "Save Page As...")</li>
                        <li class="list-group-item">Update settings above if needed</li>
                        <li class="list-group-item">Upload the HTML file</li>
                        <li class="list-group-item">Click "Process File" to extract the data</li>
                        <li class="list-group-item">Download the resulting CSV files and email templates</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results section - initially hidden -->
<div id="results-section" class="d-none">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-check-circle me-2"></i> Processing Results</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-success">
                <i class="fas fa-info-circle me-2"></i>
                File processed successfully! Below is a preview of the extracted data.
            </div>
            
            <div class="row">
                <div class="col-12 mb-4">
                    <a id="download-link" href="#" class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>Download Results
                    </a>
                </div>
                
                <!-- Tabs for different data types -->
                <div class="col-12">
                    <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button" role="tab" aria-selected="true">Contacts</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="companies-tab" data-bs-toggle="tab" data-bs-target="#companies" type="button" role="tab" aria-selected="false">Companies</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pipelines-tab" data-bs-toggle="tab" data-bs-target="#pipelines" type="button" role="tab" aria-selected="false">Pipelines</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="emails-tab" data-bs-toggle="tab" data-bs-target="#emails" type="button" role="tab" aria-selected="false">Email Templates</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0 rounded-bottom" id="resultTabsContent">
                        <div class="tab-pane fade show active" id="contacts" role="tabpanel" aria-labelledby="contacts-tab">
                            <div id="contacts-preview"></div>
                        </div>
                        <div class="tab-pane fade" id="companies" role="tabpanel" aria-labelledby="companies-tab">
                            <div id="companies-preview"></div>
                        </div>
                        <div class="tab-pane fade" id="pipelines" role="tabpanel" aria-labelledby="pipelines-tab">
                            <div id="pipelines-preview"></div>
                        </div>
                        <div class="tab-pane fade" id="emails" role="tabpanel" aria-labelledby="emails-tab">
                            <div id="emails-preview"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error Alert - initially hidden -->
<div id="error-alert" class="alert alert-danger d-none" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <span id="error-message"></span>
</div>

<!-- Loading Spinner - initially hidden -->
<div id="loading-spinner" class="text-center d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Processing file, please wait...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle form submission for settings
        const settingsForm = document.getElementById('settings-form');
        settingsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            updateSettings();
        });
        
        // Handle form submission for file upload
        const uploadForm = document.getElementById('upload-form');
        uploadForm.addEventListener('submit', function(event) {
            event.preventDefault();
            processFile();
        });
        
        // Set up download link
        const downloadLink = document.getElementById('download-link');
        downloadLink.addEventListener('click', function(event) {
            event.preventDefault();
            window.location.href = '/api/download-results';
        });
    });
    
    function updateSettings() {
        // Show loading spinner
        toggleLoading(true);
        
        // Hide any previous errors
        hideError();
        
        // Get form data
        const formData = {
            industry_vertical: document.getElementById('industry_vertical').value,
            industry: document.getElementById('industry').value,
            sourcing_analyst: document.getElementById('sourcing_analyst').value,
            investment_cycle: document.getElementById('investment_cycle').value
        };
        
        // Send API request
        fetch('/api/update-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                showToast('Settings updated successfully!', 'success');
            } else {
                // Show error message
                showError(data.message || 'Failed to update settings.');
            }
        })
        .catch(error => {
            showError('An error occurred: ' + error);
        })
        .finally(() => {
            // Hide loading spinner
            toggleLoading(false);
        });
    }
    
    function processFile() {
        // Show loading spinner
        toggleLoading(true);
        
        // Hide any previous errors and results
        hideError();
        hideResults();
        
        // Get file
        const fileInput = document.getElementById('file');
        const file = fileInput.files[0];
        
        if (!file) {
            showError('Please select a file to upload.');
            toggleLoading(false);
            return;
        }
        
        // Create form data
        const formData = new FormData();
        formData.append('file', file);
        
        // Send API request
        fetch('/api/process', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Display results
                displayResults(data.preview);
                
                // Update download link
                document.getElementById('download-link').href = data.download_url;
                
                // Show results section
                document.getElementById('results-section').classList.remove('d-none');
                
                // Scroll to results
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
            } else {
                // Show error message
                showError(data.message || 'Failed to process file.');
            }
        })
        .catch(error => {
            showError('An error occurred: ' + error);
        })
        .finally(() => {
            // Hide loading spinner
            toggleLoading(false);
        });
    }
    
    function displayResults(preview) {
        // Display contacts
        displayTable(
            'contacts-preview', 
            preview.contacts, 
            ['Contact Name', 'First Name', 'Last Name', 'Email', 'Company Name', 'Industry']
        );
        
        // Display companies
        displayTable(
            'companies-preview', 
            preview.companies, 
            ['Company Name', 'Website']
        );
        
        // Display pipelines
        displayTable(
            'pipelines-preview', 
            preview.pipelines, 
            ['Deal Name', 'Company Name', 'Contact Name', 'Sub-Pipeline', 'Stage', 'Industry Vertical']
        );
        
        // Display email templates
        const emailsPreview = document.getElementById('emails-preview');
        emailsPreview.innerHTML = '';
        
        if (preview.email_templates && preview.email_templates.length > 0) {
            preview.email_templates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                const pre = document.createElement('pre');
                pre.className = 'mb-0';
                pre.textContent = template;
                
                cardBody.appendChild(pre);
                card.appendChild(cardBody);
                emailsPreview.appendChild(card);
            });
        } else {
            emailsPreview.innerHTML = '<div class="alert alert-info">No email templates generated.</div>';
        }
    }
    
    function displayTable(elementId, data, columns) {
        const container = document.getElementById(elementId);
        container.innerHTML = '';
        
        if (data && data.length > 0) {
            const table = document.createElement('table');
            table.className = 'table table-striped table-hover';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            data.forEach(item => {
                const row = document.createElement('tr');
                
                columns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = item[column] || '';
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
        } else {
            container.innerHTML = '<div class="alert alert-info">No data available.</div>';
        }
    }
    
    function showError(message) {
        const errorAlert = document.getElementById('error-alert');
        const errorMessage = document.getElementById('error-message');
        
        errorMessage.textContent = message;
        errorAlert.classList.remove('d-none');
        
        // Scroll to error
        errorAlert.scrollIntoView({ behavior: 'smooth' });
    }
    
    function hideError() {
        document.getElementById('error-alert').classList.add('d-none');
    }
    
    function hideResults() {
        document.getElementById('results-section').classList.add('d-none');
    }
    
    function toggleLoading(show) {
        const loadingSpinner = document.getElementById('loading-spinner');
        
        if (show) {
            loadingSpinner.classList.remove('d-none');
        } else {
            loadingSpinner.classList.add('d-none');
        }
    }
    
    function showToast(message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        // Create toast content
        const toastContent = document.createElement('div');
        toastContent.className = 'd-flex';
        
        const toastBody = document.createElement('div');
        toastBody.className = 'toast-body';
        toastBody.textContent = message;
        
        const closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.className = 'btn-close btn-close-white me-2 m-auto';
        closeButton.setAttribute('data-bs-dismiss', 'toast');
        closeButton.setAttribute('aria-label', 'Close');
        
        toastContent.appendChild(toastBody);
        toastContent.appendChild(closeButton);
        toast.appendChild(toastContent);
        
        // Add toast to container
        toastContainer.appendChild(toast);
        
        // Initialize toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        
        // Show toast
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
</script>
{% endblock %}{% extends "base.html" %}

{% block title %}Crunchbase Data Extractor - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-cog me-2"></i> Settings</h4>
            </div>
            <div class="card-body">
                <form id="settings-form">
                    <div class="mb-3">
                        <label for="industry_vertical" class="form-label">Industry Vertical</label>
                        <input type="text" class="form-control" id="industry_vertical" name="industry_vertical" 
                               value="{{ settings.industry_vertical }}">
                    </div>
                    <div class="mb-3">
                        <label for="industry" class="form-label">Industry</label>
                        <input type="text" class="form-control" id="industry" name="industry" 
                               value="{{ settings.industry }}">